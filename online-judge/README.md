# OJ题目评测系统

## 项目整体架构

### 单体项目架构

![img](https://cdn.nlark.com/yuque/0/2024/jpeg/38440035/1714293990369-c8045ca4-f1cd-4de8-b568-45033ca9ebc2.jpeg)

### 微服务项目架构

![img](https://cdn.nlark.com/yuque/0/2024/jpeg/38440035/1714295725750-3c197df1-50a1-4a1e-b11f-9ef93f1de702.jpeg)

## 后端主要功能及其实现

1. 判题机模块设计，定义了代码沙箱的抽象调用接口和实现类，并通过 **静态工厂模式 + Spring 配置化** 的方式实现了对代码沙箱的灵活调用。同时使用 **代理模式** 对代码沙箱接口进行功能增强，统一实现对代码沙箱调用前后的日志记录；使用 **策略模式** 代替 if else 独立封装不同语言的判题算法，提高系统的可维护性；使用模板方法模式定义了一套标准的代码沙箱实现流程（编译、执行、获取输出、清理文件），并允许子类自行扩展部分流程。
2. 代码沙箱使用Java原生和Docker两种方式实现。Java 原生代码沙箱使用 Java Runtime 对象的 exec 方法实现了对 Java 程序的编译和执行，并通过 **Process 类** 的输入流获取执行结果；为保证沙箱宿主机的安全性，选用 Docker 隔离用户代码，使用 [**Docker Java**](https://github.com/docker-java/docker-java) 创建容器隔离执行代码，并通过 TTY 和 Docker 进行传参交互。
3. 将代码沙箱服务抽取成API接口， 为防止用户恶意请求代码沙箱服务，给调用方分配签名密钥，并通过校验请求头中的密钥保证了 API 调用安全。
4. 选用 Spring Cloud Alibaba 重构单体项目，将项目划分为用户服务、题目服务、判题服务、公共模块。使用 **Redis 分布式 Session** 存储登录用户信息，使用 **Nacos + OpenFeign** 实现了各模块之间的相互调用，使用 **Spring Cloud Gateway** 对各服务接口进行聚合和路由，保护服务的同时简化了客户端的调用（前端不用根据业务请求不同端口的服务），使用 **Knife4j Gateway** 在网关层实现了对各服务 Swagger 接口文档的统一聚合，无需通过切换地址查看各服务的文档。
5. 为防止判题操作执行时间较长，系统选用异步的方式，在题目服务中将题目提交 id 发送给 **RabbitMQ** 消息队列，并通过 Direct 交换机转发给判题队列，由判题服务进行消费，异步更新提交状态。
